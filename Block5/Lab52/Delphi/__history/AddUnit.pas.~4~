Unit AddUnit;

Interface

Uses
    Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
    System.Classes, Vcl.Graphics, Vcl.Grids,
    Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Clipbrd;

Type
    TAddForm = Class(TForm)
        NumberEdit: TEdit;

        ActionButton: TButton;
        CancelButton: TButton;

        Procedure AddFormKeyDown(Sender: TObject; Var Key: Word; Shift: TShiftState);

        Procedure NumberEditChange(Sender: TObject);
        Procedure NumberEditContextPopup(Sender: TObject; MousePos: TPoint; Var Handled: Boolean);
        Procedure NumberEditKeyDown(Sender: TObject; Var Key: Word; Shift: TShiftState);
        Procedure NumberEditKeyPress(Sender: TObject; Var Key: Char);
        Procedure NumberEditKeyUp(Sender: TObject; Var Key: Word; Shift: TShiftState);

        Procedure ActionButtonClick(Sender: TObject);
        Procedure CloseButtonClick(Sender: TObject);

    Private
        { Private declarations }
    Public
        { Public declarations }
    End;

Const
    ENTER = #13;
    BACKSPACE = #8;
    NONE = #0;
    DIGITS = ['0'..'9'];
    ALPHABET = ['A'..'Z', 'a'..'z'];
    MIN_NUM = 1;
    MAX_NUM = 999;

Var
    AddForm: TAddForm;
    CtrlPressed: Boolean = False;

Implementation

{$R *.dfm}

Uses MainUnit;

Procedure TAddForm.AddFormKeyDown(Sender: TObject; Var Key: Word; Shift: TShiftState);
Begin
    If Key = VK_ESCAPE Then
        Close;
End;



Function IsValidRange(Num: Integer; Const MIN, MAX: Integer) : Boolean;
Begin
    IsValidRange := (Num >= MIN) And (Num <= MAX);
End;

Function IsPossiblePaste(SelStart, SelLength: Integer; Text: String; Const MIN, MAX: Integer) : Boolean;
Var
    Num: Integer;
Begin
    IsPossiblePaste := Clipboard.HasFormat(CF_TEXT) And (Length(ClipBoard.AsText) <> 0) And
                       TryStrToInt(Copy(Text, 1, SelStart) + ClipBoard.AsText + Copy(Text, SelStart + SelLength + 1), Num) And
                       ((SelStart = 0) And (ClipBoard.AsText[1] <> '0') Or (SelStart > 0)) And
                       IsValidRange(StrToInt(Copy(Text, 1, SelStart) + ClipBoard.AsText + Copy(Text, SelStart + SelLength + 1)), MIN, MAX);
End;

Function IsValidChar(SelStart: Integer; Key: Char) : Boolean;
Begin
    IsValidChar := (SelStart = 0) And CharInSet(Key, DIGITS_WITHOUT_ZERO) Or (SelStart > 0) And CharInSet(Key, DIGITS);
End;

Procedure TAddForm.NumberEditChange(Sender: TObject);
Begin
    ActionButton.Enabled := NumberEdit.Text <> '';
End;

Procedure TAddForm.NumberEditContextPopup(Sender: TObject; MousePos: TPoint; Var Handled: Boolean);
Begin
    With NumberEdit Do
    Begin
        If Not IsPossiblePaste(SelStart, SelLength, Text, MIN_NUM, MAX_NUM) Or
           (SelLength = 0) And (SelStart = 1) And (Length(Text) > 1) And (Text[2] = '0') Or
           (SelLength > 0) And (SelStart = 0) And (SelLength <> Length(Text)) And (Text[SelLength + 1] = '0') Then
            Handled := True;
    End;
End;

Procedure TAddForm.NumberEditKeyDown(Sender: TObject; Var Key: Word; Shift: TShiftState);
Begin
    With NumberEdit Do
    Begin
        If (Shift = [ssCtrl]) And (UpCase(Chr(Key)) = 'X') Then
        Begin
            If (SelLength = 0) And (SelStart = 1) And (Length(Text) > 1) And (Text[2] = '0') Or
               (SelLength > 0) And (SelStart = 0) And (SelLength <> Length(Text)) And (Text[SelLength + 1] = '0') Then
                Key := Ord(NONE);
        End
        Else If Key = VK_DELETE Then
        Begin
            If (SelLength = 0) And (SelStart = 0) And (Length(Text) > 1) And (Text[2] = '0') Or
               (SelLength > 0) And (SelStart = 0) And (SelLength <> Length(Text)) And (Text[SelLength + 1] = '0') Then
                Key := Ord(NONE);
        End
        Else If (Shift = [ssCtrl]) And (UpCase(Chr(Key)) = 'V') Or (Shift = [ssShift]) And (Key = VK_INSERT) Then
        Begin
            If Not IsPossiblePaste(SelStart, SelLength, Text, MIN_NUM, MAX_NUM) Then
                Key := Ord(NONE);
        End;
        If (Shift = [ssCtrl]) And CharInSet(Chr(Key), ALPHABET) Then
            CtrlPressed := True;
    End;
End;

Procedure TAddForm.NumberEditKeyPress(Sender: TObject; Var Key: Char);
Begin
    With NumberEdit Do
    Begin
        If Key = BACKSPACE Then
        Begin
           If (SelLength = 0) And (SelStart = 1) And (Length(Text) > 1) And (Text[2] = '0') Or
              (SelLength > 0) And (SelStart = 0) And (SelLength <> Length(Text)) And (Text[SelLength + 1] = '0') Then
               Key := NONE;
        End
        Else If Key = ENTER Then
        Begin
            If ActionButton.Enabled Then
                MainForm.ResultButtonClick(MainForm.ResultButton);
        End
        Else If Not CtrlPressed Then
        Begin
            If Not (IsValidChar(SelStart, Key) And IsValidRange(StrToInt(Copy(Text, 1, SelStart) + Key + Copy(Text, SelStart + SelLength + 1)), MIN_NUM, MAX_NUM)) Then
                Key := NONE;
        End;
    End;
End;

Procedure TAddForm.NumberEditKeyUp(Sender: TObject; Var Key: Word; Shift: TShiftState);
Begin
    CtrlPressed := False;
End;



Procedure TAddForm.ActionButtonClick(Sender: TObject);
Begin

    Close;
End;

Procedure TAddForm.CloseButtonClick(Sender: TObject);
Begin
    Close;
End;

End.
